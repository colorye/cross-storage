Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var e,t=require("idb"),r=(e=require("nanoid/generate"))&&e.__esModule?e:{default:e};function n(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}require("regenerator-runtime/runtime");var i="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ";function s(e,r){var n,i,s,o,u,a,c,h;return regeneratorRuntime.async((function(d){for(;;)switch(d.prev=d.next){case 0:if("getItem"!==(n=e.split("CrossStorage:")[1])){d.next=3;break}return d.abrupt("return",(i=localStorage).getItem.apply(i,r));case 3:if("setItem"!==n){d.next=5;break}return d.abrupt("return",(s=localStorage).setItem.apply(s,r));case 5:if("removeItem"!==n){d.next=7;break}return d.abrupt("return",(o=localStorage).removeItem.apply(o,r));case 7:return d.next=9,regeneratorRuntime.awrap((0,t.openDB)("cross-storage",1,{upgrade:function(e){return e.createObjectStore("generic")}}));case 9:if(u=d.sent,"getIndexed"!==n){d.next=16;break}return d.next=13,regeneratorRuntime.awrap(u.get.apply(u,["generic"].concat(r)));case 13:return a=d.sent,u.close(),d.abrupt("return",a);case 16:if("setIndexed"!==n){d.next=22;break}return d.next=19,regeneratorRuntime.awrap(u.put("generic",r[1],r[0]));case 19:return c=d.sent,u.close(),d.abrupt("return",c);case 22:if("removeIndexed"!==n){d.next=28;break}return d.next=25,regeneratorRuntime.awrap(u.delete.apply(u,["generic"].concat(r)));case 25:return h=d.sent,u.close(),d.abrupt("return",h);case 28:case"end":return d.stop()}}),null,null,null,Promise)}var o=new function(){n(this,"open",(function(e){void 0===e&&(e=[]),this.t=function(t){var r,n,i;return regeneratorRuntime.async((function(o){for(;;)switch(o.prev=o.next){case 0:if(r="null"===t.origin?"file://":t.origin,e.some((function(e){return e instanceof RegExp&&e.test(r)}))){o.next=4;break}return o.abrupt("return");case 4:if(n=function(){try{return JSON.parse(t.data)}catch(e){}}()){o.next=7;break}return o.abrupt("return");case 7:return i={id:n.id},o.prev=8,o.next=11,regeneratorRuntime.awrap(s(n.method,n.params));case 11:i.result=o.sent,o.next=17;break;case 14:o.prev=14,o.t0=o.catch(8),i.error=o.t0;case 17:window.parent.postMessage(JSON.stringify(i),r);case 18:case"end":return o.stop()}}),null,null,[[8,14]],Promise)},window.addEventListener?window.addEventListener("message",this.t.bind(this),!1):window.attachEvent("onmessage",this.t.bind(this))})),n(this,"close",(function(){window.removeEventListener?window.removeEventListener("message",this.t,!1):window.detachEvent("onmessage",this.t)})),n(this,"connect",(function(e,t){var n=this,s=(void 0===t?{}:t).frameId,o=void 0===s?"cross-storage":s;if("local"===e)return this.connectLocal();if("CONNECTED"===this.i)return this;var u=document.getElementById(o);return u?console.error("ERROR: "+o+" has already be used. Please provide different frameId"):(u=window.document.createElement("iframe"),this.s=u,this.s.id=o,this.s.style.display="none",window.document.body.appendChild(this.s),this.s.src=e,this.o=function(t){if(("null"===t.origin?"file://":t.origin)===e){var r=function(){try{return JSON.parse(t.data)}catch(e){}}();r&&r.id&&"function"==typeof this.u[r.id]&&this.u[r.id](r.error,r.result)}},this.h=function(e,t){var n=this;if("CONNECTED"!==this.i)return console.error("ERROR: CrossStorage has not been up yet.");var s={id:(0,r.default)(i,10),method:"CrossStorage:"+e,params:t};return new Promise((function(e,t){n.m=setTimeout((function(){n.u[s.id]&&(delete n.u[s.id],t(new Error("timeout")))}),5e3),n.u[s.id]=function(r,i){if(clearTimeout(n.m),delete n.u[s.id],r)return t(new Error(r));e(i)},n.s.contentWindow.postMessage(JSON.stringify(s),n.s.src)})).catch((function(e){console.error("ERROR: ",e)}))},window.addEventListener?window.addEventListener("message",this.o.bind(this),!1):window.attachEvent("onmessage",this.o.bind(this)),new Promise((function(e){n.s.onload=function(){n.i="CONNECTED",n.u={},e(n)}})))})),n(this,"connectLocal",(function(){return this.h=function(e,t){return s({id:(0,r.default)(i,10),method:"CrossStorage:"+e,params:t}.method,t)},this})),n(this,"disconnect",(function(){this.s&&this.s.parentNode.removeChild(this.s),this.i="DISCONNECTED",window.removeEventListener?window.removeEventListener("message",this.o,!1):window.detachEvent("onmessage",this.o)})),n(this,"getItem",(function(e){return this.h("getItem",[e])})),n(this,"setItem",(function(e,t){return this.h("setItem",[e,t])})),n(this,"removeItem",(function(e){return this.h("removeItem",[e])})),n(this,"getIndexed",(function(e){return this.h("getIndexed",[e])})),n(this,"setIndexed",(function(e,t){return this.h("setIndexed",[e,t])})),n(this,"removeIndexed",(function(e,t){return this.h("removeIndexed",[e,t])}))};exports.default=o;