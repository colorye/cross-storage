Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var e,t=require("idb"),n=(e=require("nanoid/generate"))&&e.__esModule?e:{default:e};function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}require("regenerator-runtime/runtime");var i="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ";function s(e,n){var r,i,s,o,u,a,c,h;return regeneratorRuntime.async((function(d){for(;;)switch(d.prev=d.next){case 0:if("getItem"!==(r=e.split("CrossStorage:")[1])){d.next=3;break}return d.abrupt("return",(i=localStorage).getItem.apply(i,n));case 3:if("setItem"!==r){d.next=5;break}return d.abrupt("return",(s=localStorage).setItem.apply(s,n));case 5:if("removeItem"!==r){d.next=7;break}return d.abrupt("return",(o=localStorage).removeItem.apply(o,n));case 7:return d.next=9,regeneratorRuntime.awrap((0,t.openDB)("cross-storage",1,{upgrade:function(e){return e.createObjectStore("generic")}}));case 9:if(u=d.sent,"getIndexed"!==r){d.next=16;break}return d.next=13,regeneratorRuntime.awrap(u.get.apply(u,["generic"].concat(n)));case 13:return a=d.sent,u.close(),d.abrupt("return",a);case 16:if("setIndexed"!==r){d.next=22;break}return d.next=19,regeneratorRuntime.awrap(u.put("generic",n[1],n[0]));case 19:return c=d.sent,u.close(),d.abrupt("return",c);case 22:if("removeIndexed"!==r){d.next=28;break}return d.next=25,regeneratorRuntime.awrap(u.delete.apply(u,["generic"].concat(n)));case 25:return h=d.sent,u.close(),d.abrupt("return",h);case 28:case"end":return d.stop()}}),null,null,null,Promise)}var o=new function(){r(this,"open",(function(e){void 0===e&&(e=[]),this.t=function(t){var n,r,i;return regeneratorRuntime.async((function(o){for(;;)switch(o.prev=o.next){case 0:if(n="null"===t.origin?"file://":t.origin,e.some((function(e){return e instanceof RegExp&&e.test(n)}))){o.next=4;break}return o.abrupt("return");case 4:if(r=function(){try{return JSON.parse(t.data)}catch(e){}}()){o.next=7;break}return o.abrupt("return");case 7:i={id:r.id};try{i.result=s(r.method,r.params)}catch(e){i.error=e}window.parent.postMessage(JSON.stringify(i),n);case 10:case"end":return o.stop()}}),null,null,null,Promise)},window.addEventListener?window.addEventListener("message",this.t.bind(this),!1):window.attachEvent("onmessage",this.t.bind(this))})),r(this,"close",(function(){window.removeEventListener?window.removeEventListener("message",this.t,!1):window.detachEvent("onmessage",this.t)})),r(this,"connect",(function(e,t){var r=this,s=(void 0===t?{}:t).frameId,o=void 0===s?"cross-storage":s;if("local"===e)return this.connectLocal();if("CONNECTED"===this.i)return this;var u=document.getElementById(o);return u?console.error("ERROR: "+o+" has already be used. Please provide different frameId"):(u=window.document.createElement("iframe"),this.s=u,this.s.id=o,this.s.style.display="none",window.document.body.appendChild(this.s),this.s.src=e,this.o=function(t){if(("null"===t.origin?"file://":t.origin)===e){var n=function(){try{return JSON.parse(t.data)}catch(e){}}();n&&n.id&&"function"==typeof this.u[n.id]&&this.u[n.id](n.error,n.result)}},this.h=function(e,t){var r=this;if("CONNECTED"!==this.i)return console.error("ERROR: CrossStorage has not been up yet.");var s={id:(0,n.default)(i,10),method:"CrossStorage:"+e,params:t};return new Promise((function(e,t){r.m=setTimeout((function(){r.u[s.id]&&(delete r.u[s.id],t(new Error("timeout")))}),5e3),r.u[s.id]=function(n,i){if(clearTimeout(r.m),delete r.u[s.id],n)return t(new Error(n));e(i)},r.s.contentWindow.postMessage(JSON.stringify(s),r.s.src)})).catch((function(e){console.error("ERROR: ",e)}))},window.addEventListener?window.addEventListener("message",this.o.bind(this),!1):window.attachEvent("onmessage",this.o.bind(this)),new Promise((function(e){r.s.onload=function(){r.i="CONNECTED",r.u={},e(r)}})))})),r(this,"connectLocal",(function(){return this.h=function(e,t){return s({id:(0,n.default)(i,10),method:"CrossStorage:"+e,params:t}.method,t)},this})),r(this,"disconnect",(function(){this.s&&this.s.parentNode.removeChild(this.s),this.i="DISCONNECTED",window.removeEventListener?window.removeEventListener("message",this.o,!1):window.detachEvent("onmessage",this.o)})),r(this,"getItem",(function(e){return this.h("getItem",[e])})),r(this,"setItem",(function(e,t){return this.h("setItem",[e,t])})),r(this,"removeItem",(function(e){return this.h("removeItem",[e])})),r(this,"getIndexed",(function(e){return this.h("getIndexed",[e])})),r(this,"setIndexed",(function(e,t){return this.h("setIndexed",[e,t])})),r(this,"removeIndexed",(function(e,t){return this.h("removeIndexed",[e,t])}))};exports.default=o;